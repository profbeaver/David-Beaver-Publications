<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>David Beaver – Publications</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; max-width: 900px; }
    h1 { font-size: 2em; }
    .pub-entry { margin-bottom: 1.5em; }
    .pub-type { font-style: italic; color: #555; }
    a { color: #0645AD; text-decoration: none; }
    .error { color: red; margin-top: 1em; }
    #controls { margin: 1em 0; }
    select { margin-right: 1em; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>
<h1>David Beaver – Publications</h1>
<div id="controls">
  <label for="typeFilter">Type:</label>
  <select id="typeFilter">
    <option value="all">All</option>
  </select>

  <label for="themeFilter">Theme:</label>
  <select id="themeFilter">
    <option value="all">All</option>
  </select>
</div>

<div id="pubs"></div>
<div id="error" class="error"></div>

<script>
window.onload = () => {
  fetch('publications_links_cleaned.yaml')
    .then(response => {
      if (!response.ok) throw new Error('Failed to load YAML file. Check the file name and path.');
      return response.text();
    })
    .then(text => {
      const data = window.jsyaml.load(text);
      const container = document.getElementById('pubs');
      const typeSelect = document.getElementById('typeFilter');
      const themeSelect = document.getElementById('themeFilter');

      data.sort((a, b) => (b.year || 0) - (a.year || 0));

      const types = new Set(data.map(pub => pub.type));
      const themes = new Set(data.flatMap(pub => pub.themes || []));

      [...types].sort().forEach(type => {
        const opt = document.createElement('option');
        opt.value = type;
        opt.textContent = type.replace(/-/g, ' ');
        typeSelect.appendChild(opt);
      });

      [...themes].sort().forEach(theme => {
        const opt = document.createElement('option');
        opt.value = theme;
        opt.textContent = theme;
        themeSelect.appendChild(opt);
      });

      function render(typeFilter, themeFilter) {
        container.innerHTML = '';
        const filtered = data.filter(pub => {
          const matchType = typeFilter === 'all' || pub.type === typeFilter;
          const matchTheme = themeFilter === 'all' || (pub.themes && pub.themes.includes(themeFilter));
          return matchType && matchTheme;
        });

        filtered.forEach(pub => {
          const div = document.createElement('div');
          div.className = 'pub-entry';

          let citation = `<strong>${pub.title}</strong><br>${pub.authors?.join(', ')} (${pub.year || 'n.d.'}).`;

          if (pub.journal) {
            citation += ` <em>${pub.journal}</em>`;
            if (pub.volume) citation += ` ${pub.volume}`;
            if (pub.issue) citation += `(${pub.issue})`;
            if (pub.pages) citation += `, ${pub.pages}`;
            citation += '.';
          } else if (pub.book) {
            citation += ` In <em>${pub.book}</em>`;
            if (pub.editors) citation += `, eds. ${pub.editors.join(', ')}`;
            if (pub.publisher) citation += `, ${pub.publisher}`;
            if (pub.pages) citation += `, pp. ${pub.pages}`;
            citation += '.';
          } else if (pub.source) {
            citation += ` <em>${pub.source}</em>`;
            if (pub.date) citation += `, ${pub.date}`;
            citation += '.';
          } else if (pub.publisher) {
            citation += ` ${pub.publisher}.`;
          }

          citation += ` <span class="pub-type">[${pub.type.replace(/-/g, ' ')}]</span>`;
          if (pub.link) citation += ` <a href="${pub.link}" target="_blank">[Link]</a>`;

          div.innerHTML = citation;
          container.appendChild(div);
        });
      }

      render('all', 'all');

      typeSelect.addEventListener('change', () => render(typeSelect.value, themeSelect.value));
      themeSelect.addEventListener('change', () => render(typeSelect.value, themeSelect.value));
    })
    .catch(error => {
      document.getElementById('error').textContent = 'Error: ' + error.message;
    });
};
</script>
</body>
</html>
